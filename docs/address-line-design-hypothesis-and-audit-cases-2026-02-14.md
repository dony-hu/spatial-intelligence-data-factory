# 地址产线设计假设与质量审计驱动用例（2026-02-14，离线工具包版）

## 1. 目标与边界

### 1.1 目标
- 以“产线质量审计”为主驱动，让工厂 Agent 基于工厂工具包循环迭代地址产线逻辑与工具链。
- 覆盖地址从采集、标准化、关联融合、结果输出到运营反馈回流的闭环。
- 把人工运营中可训练项（尤其是互联网源核实）沉淀为可自动执行/可学习能力。

### 1.2 边界约束
- 当前版本不规划连接 LLM 进行治理能力。
- 地址产线不连接互联网时，不得使用内置地域知识先验（例如默认“上海市”）。
- 地址知识仅允许来自本地已加载的工厂工具包（toolpack）。
- 图中明确依赖人工标注的工序暂不纳入自动化范围。
- 但人工运营中的“互联网源核实”“文本可信度评估”“坐标置信度复核”纳入 Agent 可训练能力池。
- 所有写操作遵循确认门禁：`pending_confirmation -> confirmation/respond`。

---

## 2. 地址产线设计假设（H）

### H1：产线采用“7段式主干 + 审计回流支路”
主干阶段：
1) 前期准备
2) 采集地址吸收建库
3) 标准地址建库
4) 关联融合
5) 项目库自动化运营
6) 项目库人工运营（可训练部分自动化）
7) 成果输出

回流支路：
- 每个阶段结束后进入质量审计，审计失败进入“缺失能力补充/策略调优/工具重编译”，再回到对应阶段重跑。

### H2：质量审计优先于规则补丁
- 不直接靠固定规则堆砌“补丁式修复”。
- 由审计结果触发工具链迭代：
  - 产线步骤增删改
  - 参数调优
  - 工具脚本重编译
  - 缺失能力清单（包括外部源、密钥、字段契约）

### H3：人工运营能力可“训练化”
- 互联网源核实视为标准工具能力：
  - 输入：标准地址、别名、地理上下文
  - 输出：多源证据包（source/verdict/score/captured_at）
- 人工反馈不只改结果，还要产出“训练样本”：
  - 决策理由
  - 证据链接
  - 冲突类型
  - 可复用判别特征

### H4：融合阶段先保障可追溯，再追求自动化率
- 关联融合必须保留来源链路：原始地址 -> 标准地址 -> 融合地址 -> 成果记录。
- 对冲突结果优先打标签降级，不允许静默覆盖。

### H5：缺失能力补充是正式阶段而非异常分支
- 任何阶段出现 `MISSING_CAPABILITY` 都进入“缺失地址补充”工序。
- 工厂 Agent 必须输出：
  - 缺失能力分类（数据/工具/源接入/策略）
  - 临时降级策略
  - 下一迭代最小可行修复包

---

## 3. 质量审计驱动的 Agent 迭代机制

## 3.1 审计对象
- 过程质量：步骤覆盖率、步骤执行成功率、门禁遵循率。
- 数据质量：完整性、规范性、一致性、唯一性、可追溯性。
- 核实质量：真实源命中率、冲突识别率、不可核实降级准确率。
- 结果质量：成果可用率、回放可复现率、版本差异可解释性。

## 3.2 迭代闭环
1) 工具包驱动生成/修订 `process_spec` 与 `tool_scripts`
2) 编译器检查可执行性（ready/partial/blocked）
3) 沙盒运行目标用例集
4) 审计引擎打分并归因失败点
5) 将审计报告回灌给流程编排器进行下一轮设计
6) 达到阈值后进入确认门禁并发布版本

## 3.3 审计阈值（建议初版）
- P0用例通过率 >= 0.95
- 互联网核实类用例通过率 >= 0.90
- 冲突标签准确率 >= 0.92
- 不可核实误判率 <= 0.03
- 写操作门禁违规率 = 0

---

## 4. 逻辑能力与工具链映射（可由 Agent 迭代生成）

### 4.1 阶段能力映射
1) 前期准备
- 能力：需求拆解、数据盘点、指标初始化
- 工具：`prepare_scope.py`、`baseline_metrics.py`

2) 采集地址吸收建库
- 能力：采集、指标准备、语义补充、敏感质检
- 工具：`ingest_collector.py`、`address_semantic_enricher.py`、`privacy_guard.py`

3) 标准地址建库
- 能力：入池标识、坐标补充、层级规范化、补名
- 工具：`standardize_address.py`、`geo_resolver.py`、`hierarchy_normalizer.py`

4) 关联融合
- 能力：服务发布、业务地址入池、关系自动化、缺失补充
- 工具：`relation_builder.py`、`linkage_initializer.py`、`missing_capability_router.py`

5) 项目库自动化运营
- 能力：文本可信度打标、坐标置信度打标、自动修复策略
- 工具：`text_credibility_scorer.py`、`coord_confidence_scorer.py`、`auto_fix_planner.py`

6) 项目库人工运营（可训练）
- 能力：互联网源核实、争议样本复核、策略回写
- 工具：`internet_source_verifier.py`、`evidence_merger.py`、`feedback_to_training_set.py`

7) 成果输出
- 能力：核查表导出、核准结果分发、版本统计
- 工具：`result_exporter.py`、`release_reporter.py`

### 4.2 强制输出契约
- 每次核实必须输出 `verification_status`：
  - `VERIFIED_EXISTS`
  - `VERIFIED_NOT_EXISTS`
  - `UNVERIFIABLE_ONLINE`
- 冲突与降级必须输出：
  - `SOURCE_CONFLICT`
  - `MISSING_CAPABILITY`

---

## 5. 用例构造原则

### 5.1 分层
- P0：主链路必过（标准化、核实、融合、导出）
- P1：真实复杂场景（别名、跨源冲突、互联网证据冲突）
- P2：降级与容错（缺失源、超时、脏数据）

### 5.2 驱动信号
每条用例除了输入与期望输出，还必须包含：
- 审计关注点（audit_focus）
- 触发迭代动作（expected_iteration_action）
- 目标阶段（target_stage）
- 目标工具（target_tools）

### 5.3 用例文件
- 结构化用例集：`testdata/fixtures/address-line-quality-audit-cases-2026-02-14.json`

---

## 6. 训练与发布建议

1) 先使用用例集跑“离线审计迭代”3轮，冻结阶段逻辑。
2) 接入真实互联网源后，再开启“在线审计迭代”并记录不稳定源。
3) 仅当 P0 稳定达标且门禁违规为0时，允许进入发布确认。
4) 每次发布必须产出：版本差异、失败样例、回滚点、缺失能力清单。
