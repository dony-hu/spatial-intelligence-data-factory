# BMAD 工程化执行包：模拟逻辑替换为真实执行（2026-02-12）

## 1. 目标与范围

### 1.1 目标

将当前演示系统中的模拟执行逻辑替换为真实地址清洗与真实图谱构建逻辑，确保：

1. 单 case 可追踪真实输入与真实输出。
2. `completed` 状态与业务产物有效性一致。
3. 看板展示可解释、可审计、可复核。

### 1.2 范围

1. 仅覆盖地址治理相关流水（地址清洗 → 地址-图谱）。
2. 仅覆盖当前仓库的执行引擎与看板链路。
3. 不含地区定制规则，不含生产外部系统接入。

---

## 2. BMAD 分阶段交付

## 2.1 Analysis

### 交付物

1. 单 case 语义定义（单条地址输入）。
2. 成功/失败判定口径（产物门禁）。
3. 异常样例清单（空地址、模糊地址、冲突地址）。

### 通过门禁

1. 口径评审通过（PM + 架构 + 开发）。
2. 验收样例集冻结（不少于 20 条）。

## 2.2 Planning

### 交付物

1. Epic/Story/Task 清单（含优先级与工时）。
2. 输出契约（清洗输出、图谱输出）。
3. 测试策略（单测/集成/E2E）。

### 通过门禁

1. 所有 P0 Story 具备可执行验收标准。
2. 所有 P0 Story 具备回滚方案。

## 2.3 Solutioning

### 交付物

1. 执行链路架构：`Input -> Cleaning -> Graph -> Gates -> State`。
2. 状态机语义修订：流程完成 != 业务成功。
3. 证据链结构定义。

### 通过门禁

1. 架构评审通过。
2. 关键风险项有缓解策略。

## 2.4 Implementation

### 交付物

1. 真实执行代码落地。
2. 看板结构化详情落地。
3. 自动化测试与 CI 门禁落地。

### 通过门禁

1. `quick_test` 全通过且有真实产物。
2. 不再出现 `completed` 且 `nodes=0` 的未标错记录。

---

## 3. Epic 分解（专项）

## EPIC-RE1：真实地址清洗执行引擎

### 业务价值

消除随机模拟输出，提供稳定、可复核的清洗产物。

### Story

1. `RE1-S1`：实现真实地址拆解与标准化输出。
2. `RE1-S2`：实现清洗质量规则（必填、结构完整、置信度）。
3. `RE1-S3`：清洗失败分支状态与错误码落库。

### 验收标准

1. 任意有效地址可生成 `standardized_address` 与结构化组件。
2. 清洗失败时工单状态为 `failed`，不可标 `completed`。

## EPIC-RE2：真实图谱构建引擎

### 业务价值

确保图谱阶段具备真实业务产物，而非流程空跑。

### Story

1. `RE2-S1`：基于清洗结果生成节点（至少城市/区/道路/门牌）。
2. `RE2-S2`：生成基础关系（contains/belongs_to）。
3. `RE2-S3`：图谱产物门禁（`nodes>=1`，否则失败）。

### 验收标准

1. `quick_test` 每条 case 产出至少 1 个节点。
2. 图谱空产出时状态为 `failed` 并输出原因。

## EPIC-RE3：状态机与证据链语义修正

### 业务价值

消除“流程完成但产物无效”的状态误导。

### Story

1. `RE3-S1`：状态机改造（业务门禁后再 `completed`）。
2. `RE3-S2`：每 case 写入输入摘要、清洗输出摘要、图谱输出摘要。
3. `RE3-S3`：失败分类与可追踪错误上下文。

### 验收标准

1. Evidence 可重建单 case 全路径。
2. 状态与产物门禁结果一致。

## EPIC-RE4：看板与可观测性改造

### 业务价值

让运营人员直接看到每次生产输入与两条产线输出。

### Story

1. `RE4-S1`：动态列表展示归属产线与状态。
2. `RE4-S2`：详情弹框结构化展示（输入/清洗输出/图谱输出）。
3. `RE4-S3`：异常 case 高亮与快速筛选。

### 验收标准

1. 列表可定位每次生产归属与时间。
2. 详情可读，不依赖裸 JSON 理解。

## EPIC-RE5：测试与 CI 门禁

### 业务价值

将“真实执行”变更固化为可持续质量能力。

### Story

1. `RE5-S1`：单测覆盖清洗与图谱关键路径。
2. `RE5-S2`：集成测试覆盖 `quick_test` 与失败分支。
3. `RE5-S3`：CI 门禁阻断“空产物却 completed”的回归。

### 验收标准

1. 单测/集成/E2E 均通过。
2. 新回归在 CI 中可被捕获。

---

## 4. Story 级待办（P0/P1）

| Story | 优先级 | 预估 | 责任角色 | 依赖 | 验收 |
|---|---|---|---|---|---|
| RE1-S1 真实清洗输出 | P0 | 2d | Dev | 无 | 输出结构字段完整 |
| RE2-S1 节点生成 | P0 | 2d | Dev | RE1-S1 | 每 case 节点>=1 |
| RE2-S3 图谱门禁 | P0 | 1d | Dev | RE2-S1 | 空产出即失败 |
| RE3-S1 状态机修正 | P0 | 1d | Dev | RE2-S3 | completed 语义正确 |
| RE3-S2 证据链摘要 | P0 | 1d | Dev | RE3-S1 | 可追踪单 case |
| RE5-S2 集成测试 | P0 | 1d | QA/Dev | RE1/2/3 | quick_test 全绿 |
| RE4-S2 详情弹框结构化 | P1 | 1d | FE/Dev | RE3-S2 | 可读展示 |
| RE4-S3 异常筛选 | P1 | 1d | FE/Dev | RE4-S2 | 可快速定位异常 |
| RE5-S3 CI 回归门禁 | P1 | 1d | DevOps/Dev | RE5-S2 | 回归可阻断 |

---

## 5. Sprint 建议

### Sprint-1（5~7 天，P0）

1. RE1-S1 / RE2-S1 / RE2-S3
2. RE3-S1 / RE3-S2
3. RE5-S2

### Sprint-2（3~5 天，P1）

1. RE4-S2 / RE4-S3
2. RE5-S3

---

## 6. DoD（专项）

1. 每个有效 case 必有清洗输出与图谱输出。
2. `completed` 必须满足门禁，不允许空产物成功。
3. 看板可按 case 查看输入与两条产线输出详情。
4. CI 对关键回归具阻断能力。

---

## 7. 风险与缓解

1. 清洗规则复杂度提升导致时延波动。
- 缓解：分层规则与缓存策略。

2. 图谱抽取规则不稳定。
- 缓解：最小节点集兜底策略 + 错误分类监控。

3. 看板渲染大量详情导致前端性能下降。
- 缓解：只保留最近 N 条，详情按需加载。
