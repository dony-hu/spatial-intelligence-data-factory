<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据工厂实时看板</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #12345b 0%, #1f5a8f 100%);
      color: #0f172a;
      min-height: 100vh;
      padding: 20px;
    }
    .wrap { max-width: 1200px; margin: 0 auto; }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.15);
      padding: 18px;
      margin-bottom: 16px;
    }
    .head { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .head h1 { font-size: 24px; color: #0f2f52; }
    .badge { background: #1f7a43; color: #fff; border-radius: 999px; padding: 4px 10px; font-size: 12px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .metric { border: 1px solid #d8e5f3; border-radius: 10px; padding: 12px; background: #f7fbff; }
    .metric .label { color: #4b5f75; font-size: 12px; }
    .metric .value { margin-top: 6px; color: #0f2f52; font-size: 28px; font-weight: 700; }
    .two { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); }
    .line { border: 1px solid #d8e5f3; border-radius: 10px; padding: 12px; background: #fbfdff; }
    .line h3 { font-size: 16px; color: #0f2f52; margin-bottom: 8px; }
    .meta { color: #4b5f75; font-size: 13px; line-height: 1.7; }
    .bar { margin-top: 10px; width: 100%; height: 10px; border-radius: 999px; background: #dbe7f4; overflow: hidden; }
    .fill { height: 100%; background: linear-gradient(90deg, #1f5a8f, #2f8dd0); width: 0%; transition: width .25s ease; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid #e2ebf5; text-align: left; padding: 8px; }
    th { color: #39546f; }
    .foot { color: #4b5f75; font-size: 12px; text-align: right; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card head">
      <h1>数据工厂实时看板</h1>
      <div>
        <span class="badge" id="status">运行中</span>
      </div>
    </section>

    <section class="card grid">
      <div class="metric"><div class="label">已处理地址</div><div class="value" id="processed">0</div></div>
      <div class="metric"><div class="label">完成任务</div><div class="value" id="completed">0</div></div>
      <div class="metric"><div class="label">质检合格率</div><div class="value" id="quality">0%</div></div>
      <div class="metric"><div class="label">Token 消耗</div><div class="value" id="tokens">0</div></div>
    </section>

    <section class="card two">
      <div class="line">
        <h3>产线1：地址清洗</h3>
        <div class="meta" id="line1-meta">等待数据...</div>
        <div class="bar"><div class="fill" id="line1-fill"></div></div>
      </div>
      <div class="line">
        <h3>产线2：地址-图谱</h3>
        <div class="meta" id="line2-meta">等待数据...</div>
        <div class="bar"><div class="fill" id="line2-fill"></div></div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-bottom:8px;color:#0f2f52;">最近地址处理明细（前20条）</h3>
      <table>
        <thead><tr><th>ID</th><th>原始地址</th><th>状态</th><th>时间</th></tr></thead>
        <tbody id="rows"><tr><td colspan="4">暂无数据</td></tr></tbody>
      </table>
    </section>

    <section class="card foot">最后更新：<span id="updated">--</span></section>
  </div>

  <script>
    function pct(n, d) {
      if (!d) return 0;
      return Math.max(0, Math.min(100, Math.round((n / d) * 100)));
    }

    async function refresh() {
      try {
        const [statusResp, detailsResp] = await Promise.all([
          fetch('/api/status', { cache: 'no-store' }),
          fetch('/api/address-details', { cache: 'no-store' })
        ]);
        const state = await statusResp.json();
        const detailsData = await detailsResp.json();
        const details = detailsData.address_details || [];

        document.getElementById('status').textContent = state.status || 'unknown';
        document.getElementById('processed').textContent = (state.metrics?.processed_count ?? 0).toString();
        document.getElementById('completed').textContent = (state.work_orders?.completed ?? 0).toString();
        document.getElementById('quality').textContent = `${Math.round((state.metrics?.quality_rate ?? 0) * 100)}%`;
        document.getElementById('tokens').textContent = (state.metrics?.total_tokens ?? 0).toFixed(2);

        const totalProcessed = state.metrics?.processed_count ?? 0;
        const line1 = state.production_lines?.line_address_cleaning || {};
        const line2 = state.production_lines?.line_address_to_graph || {};

        document.getElementById('line1-meta').textContent = `完成任务 ${line1.completed_tasks ?? 0}，工人 ${line1.workers ?? 0}，Token ${(line1.total_tokens_consumed ?? 0).toFixed(2)}`;
        document.getElementById('line2-meta').textContent = `完成任务 ${line2.completed_tasks ?? 0}，工人 ${line2.workers ?? 0}，Token ${(line2.total_tokens_consumed ?? 0).toFixed(2)}`;

        document.getElementById('line1-fill').style.width = `${pct(line1.completed_tasks ?? 0, totalProcessed || 1)}%`;
        document.getElementById('line2-fill').style.width = `${pct(line2.completed_tasks ?? 0, totalProcessed || 1)}%`;

        const rows = details.slice(-20).reverse().map((d) => {
          const t = d.timestamp ? new Date(d.timestamp).toLocaleTimeString() : '--';
          return `<tr><td>${d.addr_id ?? '-'}</td><td>${d.raw_address ?? '-'}</td><td>${d.status ?? '-'}</td><td>${t}</td></tr>`;
        }).join('');
        document.getElementById('rows').innerHTML = rows || '<tr><td colspan="4">暂无数据</td></tr>';

        document.getElementById('updated').textContent = new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById('status').textContent = '连接失败';
      }
    }

    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
