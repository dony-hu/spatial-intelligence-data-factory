# 🏭 数据工厂实时演示系统

## 系统简介

这是一个**动态Web看板**系统，展示两条产线的**实时运行状态**。与之前的静态HTML不同，这个系统提供：

- ✅ **实时Web服务** - 基于HTTP的轻量级服务器
- ✅ **动态数据更新** - 每秒自动刷新最新数据
- ✅ **实时产线可视化** - 看到两条产线的运行过程
- ✅ **真实处理延迟** - 每条地址处理1秒，完整演示工作过程

## 架构设计

```
后端系统                           前端看板
┌─────────────────┐              ┌──────────────────┐
│ FactoryWorkflow │              │  实时HTML看板    │
│  (两条产线)      │◄──────API────│  (HTTP客户端)   │
└─────────────────┘    JSON       └──────────────────┘
    ↓                              ↑
┌─────────────────┐              自动刷新(1秒)
│  HTTP服务器      │
│  (端口5000)      │
└─────────────────┘
```

### 两条产线的处理流

```
地址数据
  ↓
【产线1】地址清洗
  - 工序: 解析 → 标准化 → 验证
  - 输出: 标准化地址
  ↓
【产线2】地址-图谱
  - 工序: 特征提取 → 融合 → 验证  
  - 输出: 图谱节点和关系
  ↓
最终产品: 空间实体知识图谱
```

## 快速开始

### 1. 启动实时演示

```bash
# 处理30条地址(约30秒)
python3 scripts/factory_live_demo.py --addresses 30

# 处理100条地址(约100秒, 约1.7分钟)
python3 scripts/factory_live_demo.py --addresses 100

# 处理10000条地址(约10000秒, 约2.7小时)
python3 scripts/factory_live_demo.py --addresses 10000
```

### 2. 打开看板

启动演示脚本后，在浏览器打开：
```
http://localhost:5000
```

## 看板功能

### 实时指标卡 (Top)

| 指标 | 说明 | 实时更新 |
|------|------|--------|
| 处理进度 | 已处理的地址数 | ✓ 每秒更新 |
| 完成任务 | 两条产线完成的任务总数 | ✓ 每秒更新 |
| 质检合格率 | 质检结果百分比 | ✓ 每秒更新 |
| Token消耗 | 累计消耗的tokens | ✓ 每秒更新 |

### 两条产线卡片

#### 【产线1】地址清洗产线

```
┌─────────────────────────────────┐
│  地址清洗产线          [运行中]   │
├─────────────────────────────────┤
│ 完成任务: 25      │  工人数: 2    │
│ 成本: 50.25      │  工序: 3      │
├─────────────────────────────────┤
│ 工序进度: [████░░░░░░░░░░] 50%   │
│                                 │
│ 📥 输入: 原始地址                │
│ 📤 输出: 标准化地址              │
│ 工序: 解析 → 标准化 → 验证       │
└─────────────────────────────────┘
```

#### 【产线2】地址-图谱产线

```
┌─────────────────────────────────┐
│  地址-图谱产线         [等待中]   │
├─────────────────────────────────┤
│ 完成任务: 20      │  工人数: 2    │
│ 成本: 42.50      │  工序: 3      │
├─────────────────────────────────┤
│ 工序进度: [███░░░░░░░░░░░░░] 30% │
│                                 │
│ 📥 输入: 标准化地址              │
│ 📤 输出: 图谱节点&关系           │
│ 工序: 特征提取 → 融合 → 验证     │
└─────────────────────────────────┘
```

### 实时图表

- **任务完成状态** (圆饼图)
  - 已完成 (绿色)
  - 进行中 (黄色)
  - 等待中 (红色)

- **产线成本分布** (柱状图)
  - 清洗产线成本 (蓝色)
  - 图谱产线成本 (紫色)

## 工作流程详解

### 单个地址的处理过程

```
时刻0s:  地址1 进入产线1 → 【解析】
时刻0.3s: 【标准化】
时刻0.6s: 【验证】 → 地址1完成 → 进入产线2
时刻0.7s: 地址2 进入产线1     地址1【特征提取】
时刻0.9s: 地址1【融合】
时刻1.0s: 地址1【验证】完成 → 图谱数据输出
         地址3 进入产线1     地址2【特征提取】
...
```

### 每条产线的独立计数

- **产线1的任务**: 100条地址 = 100个任务
  - 每个任务3个工序(解析、标准化、验证)
  
- **产线2的任务**: 100条地址 = 100个任务
  - 每个任务3个工序(特征提取、融合、验证)

- **总任务数**: 200个 (100 × 2条产线)
- **总工序执行**: 600次 (200个任务 × 3个工序)

## 实时更新机制

### 后端更新(Server Side)

```python
# 每处理一条地址后，更新全局状态
factory_state['metrics'] = {
    'processed_count': addr_id + 1,      # 已处理数
    'total_tokens': total_tokens,         # 总消耗
    'quality_rate': pass_rate             # 合格率
}
```

### 前端更新(Client Side)

```javascript
// 每1秒自动刷新数据
setInterval(() => {
    fetch('/api/status')
        .then(data => updateUI(data))
}, 1000);
```

## 性能指标

| 指标 | 值 |
|------|-----|
| Web服务器端口 | 5000 |
| 更新频率 | 1秒 |
| 处理速度 | 1条地址/秒 |
| 30条地址耗时 | ~30秒 |
| 100条地址耗时 | ~100秒(1.7分钟) |
| 10000条地址耗时 | ~10000秒(2.7小时) |

## 键盘快捷键

- **Ctrl+C**: 停止演示
- **浏览器刷新**: 重新加载看板

## 文件结构

```
tools/
├── factory_simple_server.py    # HTTP服务器 + HTML看板
└── factory_workflow.py          # 两条产线编排

scripts/
├── factory_live_demo.py         # 实时演示脚本
└── factory_continuous_demo.py   # 原始演示脚本

database/
└── factory.db                   # SQLite数据库
```

## 常见问题

**Q: 看板显示"连接服务器中..."**
A: 说明HTTP服务器还在启动或脚本已完成。等待服务器就绪或重新启动脚本。

**Q: 看板数据不更新**
A: 检查浏览器开发者工具Console，查看是否有CORS或网络错误。

**Q: 如何停止演示**
A: 在终端按 Ctrl+C，然后关闭浏览器标签。

**Q: 能否改变处理速度**
A: 可以修改 `factory_live_demo.py` 中的 `time.sleep(1)` 时间。

## 技术栈

- **后端**: Python 3.9+ (HTTP标准库)
- **前端**: HTML5 + Bootstrap + Chart.js
- **通信**: REST API + JSON
- **数据库**: SQLite3

## 下一步

实现更高级的特性：
- [ ] WebSocket实时推送 (无需客户端轮询)
- [ ] 分布式处理多条产线
- [ ] 自定义处理速度控制
- [ ] 历史数据回放
- [ ] 产线性能对比分析

