name: nightly-quality-gate

on:
  schedule:
    # 21:30 CST daily
    - cron: "30 13 * * *"
  workflow_dispatch:

jobs:
  nightly-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-governance.txt
          python -m pip install -r requirements-web-e2e.txt
          python -m pip install pytest

      - name: Install Playwright Chromium
        run: |
          python -m playwright install --with-deps chromium

      - name: Run nightly quality gate
        run: |
          PYTHONPATH=. python scripts/run_nightly_quality_gate.py

      - name: Upload nightly artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-quality-gate-artifacts
          path: |
            output/workpackages/nightly-quality-gate-latest.md
            output/workpackages/nightly-quality-gate-latest.json
            output/workpackages/nightly-failure-alert-latest.json
            output/workpackages/nightly-failure-alert-history.jsonl
            output/lab_mode/web_e2e_latest.json
            output/dashboard/test_status_board.json
            output/dashboard/dashboard_events.jsonl
